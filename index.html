<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blue Protocol Module Calculator</title>
<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<style>
  body { font-family: Arial,sans-serif; margin:0; background:#121212; color:#eee; }
  h1 { text-align:center; margin:20px 0; color:#00bcd4; }
  table { border-collapse: collapse; width:100%; margin-bottom:20px; }
  th, td { border:1px solid #333; padding:6px; text-align:center; }
  th { background:#1e1e1e; color:#00bcd4; position: sticky; top:0; z-index:1; }
  input[type=number] { width:60px; text-align:center; background:#222; border:none; color:#eee; }
  input[name="name"] { width:120px; background:#222; color:#eee; border:none; }
  .btn { padding:5px 10px; margin:5px; cursor:pointer; border:none; border-radius:5px; color:white; font-weight:bold; }
  .btn-blue { background:#00bcd4; }
  .btn-red { background:#e74c3c; }
  .btn-green { background:#2ecc71; }
  .container { max-width:1400px; margin:auto; padding:10px; }
  .highlight { outline: 3px solid #ff9800; }
  .stats-toggle { margin:10px 0; }
  .dark-table th, .dark-table td { border-color:#444; }
  .dark-table td { transition: background 0.2s; }
</style>
</head>
<body>
<div class="container">
<h1>Blue Protocol: Module Calculator</h1>
<input type="file" id="csvInput" accept=".csv">
<div class="stats-toggle"></div>
<div id="root"></div>
</div>

<script type="text/javascript">
const e = React.createElement;

const STATS = [
  "Strength Boost","Agility Boost","Intellect Boost","Special Attack","Elite Strike",
  "Healing Boost","Healing Enhance","Resistance","Armor","Cast Focus",
  "Attack SPD","Crit Focus","Luck Focus"
];

const thresholds = [[6,20],[5,16],[4,12],[3,8],[2,4],[1,1]];

function level_for(total){
  for(const [lvl,req] of thresholds){
    if(total >= req) return lvl;
  }
  return 0;
}

function combinations(arr, k){
  const results = [];
  function comb(current, start){
    if(current.length === k){ results.push([...current]); return; }
    for(let i=start;i<arr.length;i++){ current.push(arr[i]); comb(current,i+1); current.pop(); }
  }
  comb([],0);
  return results;
}

function getColorForValue(val){
  if(val <=0) return '#222';
  else if(val <=3) return '#2c2c2c';
  else if(val <=7) return '#444';
  else if(val <=12) return '#666';
  else if(val <=20) return '#888';
  else return '#aaa';
}

// CSV export helper
function exportCSV(data, stats, filename="best_modules.csv"){
  let csv = [ ["Module Names", ...stats.map(s=>"Lvl "+s)].join(",") ];
  data.forEach(row=>{
    const line = [row.combo.split(",").join(";"), ...stats.map(s=>row[s+"_lvl"])];
    csv.push(line.join(","));
  });
  const blob = new Blob([csv.join("\n")], {type:'text/csv'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}

function App(props){
  const initialData = props?.initialData || [{name:"X1", ...Object.fromEntries(STATS.map(s=>[s,0]))}];
  const [data,setData] = React.useState(initialData);
  const [bestResults,setBestResults] = React.useState({});
  const [visibleStats,setVisibleStats] = React.useState(STATS.reduce((acc,s)=>{acc[s]=true;return acc;},{}));

  const handleChange = (i,key,val)=>{
    const copy = [...data];
    copy[i][key] = key==="name"? val : Number(val)||0;
    setData(copy);
  }
  const handleAddRow = ()=>{
    const newModule = {name:`X${data.length+1}`};
    STATS.forEach(s=>newModule[s]=0);
    setData([...data,newModule]);
  }
  const handleRemoveRow = (i)=>setData(data.filter((_,idx)=>idx!==i));
  const toggleStat = (stat)=> setVisibleStats({...visibleStats, [stat]:!visibleStats[stat]});

  // Compute best combinations
  React.useEffect(()=>{
    if(data.length<4) return;
    const allComb = combinations(data,4);
    const results = [];
    allComb.forEach(combo=>{
      const sums = {};
      STATS.forEach(s=>sums[s]=combo.reduce((acc,m)=>acc+m[s],0));
      const lvls = {};
      STATS.forEach(s=>lvls[s]=level_for(sums[s]));
      const min_lvl = Math.min(...Object.values(lvls));
      results.push({combo:combo.map(m=>m.name).join(","), sums, lvls, min_lvl});
    });
    // Sort per stat
    const topPerStat = {};
    STATS.forEach(s=>{
      topPerStat[s] = [...results].sort((a,b)=>b.lvls[s]-a.lvls[s]).slice(0,5);
    });
    const topTotal = [...results].sort((a,b)=>{
      const sumA = STATS.reduce((acc,s)=>acc+a.lvls[s],0);
      const sumB = STATS.reduce((acc,s)=>acc+b.lvls[s],0);
      return sumB - sumA;
    }).slice(0,10);
    const balanced = [...results].sort((a,b)=>{
      if(b.min_lvl !== a.min_lvl) return b.min_lvl - a.min_lvl;
      const sumA = STATS.reduce((acc,s)=>acc+a.lvls[s],0);
      const sumB = STATS.reduce((acc,s)=>acc+b.lvls[s],0);
      return sumB - sumA;
    }).slice(0,10);
    setBestResults({topPerStat, topTotal, balanced});
  },[data]);

  return e('div',null,
    e('div',{className:"mb-2"},
      e('button',{className:"btn btn-blue", onClick:handleAddRow},'+ Add Module'),
      e('button',{className:"btn btn-red", onClick:()=>setData([])},'Clear Table')
    ),
    e('div',{className:"stats-toggle"},
      STATS.map(s=>e('label',{key:s, style:{marginRight:"10px"}}, 
        e('input',{type:'checkbox', checked:visibleStats[s], onChange:()=>toggleStat(s)}), " "+s
      ))
    ),
    e('table',{className:'dark-table'},
      e('thead',null,e('tr',null,
        e('th',null,'Module Name'),
        STATS.map(s=>visibleStats[s]?e('th',{key:s},s):null),
        e('th',null,'Remove')
      )),
      e('tbody',null,data.map((row,i)=>e('tr',{key:i},
        e('td',{style:{fontWeight:'bold'}},row.name),
        STATS.map(s=>visibleStats[s]?e('td',{key:s, style:{backgroundColor:getColorForValue(row[s])}}, row[s]):null),
        e('td',null,e('button',{className:"btn btn-red", onClick:()=>handleRemoveRow(i)},'âœ•'))
      )))
    ),
    bestResults.topPerStat && Object.keys(bestResults.topPerStat).map(stat=>{
      return e('div',{key:stat,className:'results'},
        e('h3',null,'Top '+stat+' combos'),
        e('button',{className:'btn btn-green', onClick:()=>exportCSV(bestResults.topPerStat[stat], STATS, 'top_'+stat+'.csv')},'Export CSV'),
        e('table',{className:'dark-table'},
          e('thead',null,e('tr',null,
            e('th',null,'Modules'),
            STATS.map(s=>visibleStats[s]?e('th',{key:s},s+' Lvl'):null)
          )),
          e('tbody',null,bestResults.topPerStat[stat].map((r,i)=>e('tr',{key:i},
            e('td',{style:{fontWeight:'bold', background:'#ff9800'}}, r.combo),
            STATS.map(s=>visibleStats[s]?e('td',{key:s},r.lvls[s]):null)
          )))
        )
      );
    }),
    bestResults.topTotal && e('div',{className:'results'},
      e('h3',null,'Top Total combos'),
      e('button',{className:'btn btn-green', onClick:()=>exportCSV(bestResults.topTotal, STATS,'top_total.csv')},'Export CSV'),
      e('table',{className:'dark-table'},
        e('thead',null,e('tr',null,
          e('th',null,'Modules'),
          STATS.map(s=>visibleStats[s]?e('th',{key:s},s+' Lvl'):null)
        )),
        e('tbody',null,bestResults.topTotal.map((r,i)=>e('tr',{key:i},
          e('td',{style:{fontWeight:'bold', background:'#ff9800'}}, r.combo),
          STATS.map(s=>visibleStats[s]?e('td',{key:s},r.lvls[s]):null)
        )))
      )
    ),
    bestResults.balanced && e('div',{className:'results'},
      e('h3',null,'Best Balanced combos (maximize min level)'),
      e('button',{className:'btn btn-green', onClick:()=>exportCSV(bestResults.balanced, STATS,'best_balanced.csv')},'Export CSV'),
      e('table',{className:'dark-table'},
        e('thead',null,e('tr',null,
          e('th',null,'Modules'),
          STATS.map(s=>visibleStats[s]?e('th',{key:s},s+' Lvl'):null)
        )),
        e('tbody',null,bestResults.balanced.map((r,i)=>e('tr',{key:i},
          e('td',{style:{fontWeight:'bold', background:'#ff9800'}}, r.combo),
          STATS.map(s=>visibleStats[s]?e('td',{key:s},r.lvls[s]):null)
        )))
      )
    )
  );
}

// Render
ReactDOM.createRoot(document.getElementById('root')).render(e(App));

// CSV Import
document.getElementById('csvInput').addEventListener('change',function(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(evt){
    const lines = evt.target.result.trim().split('\n');
    const headers = lines[0].split(',').map(h=>h.trim());
    const rows = lines.slice(1).map(l=>{
      const vals = l.split(',');
      const obj = {};
      headers.forEach((h,i)=>obj[h==="Module Name"?"name":h]=Number(vals[i]||0));
      return obj;
    });
    ReactDOM.createRoot(document.getElementById('root')).render(e(App,{initialData:rows}));
  };
  reader.readAsText(file);
});
</script>
</body>
</html>
